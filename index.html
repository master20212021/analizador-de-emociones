<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Emociones – Versión Pro</title>
    <!-- Incluye Tailwind CSS desde CDN para estilos minimalistas y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome para íconos de redes sociales y de contenido -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos base para el cuerpo, consistentes con las otras páginas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* Fondo casi negro consistente */
            color: #E5E7EB; /* Texto gris claro consistente */
            overflow-x: hidden; /* Evita scroll horizontal */
            min-height: 100vh; /* Asegura que el body ocupe al menos la altura completa del viewport */
            display: flex; /* Convierte el body en un flex container */
            flex-direction: column; /* Apila los hijos verticalmente */
            align-items: center; /* Centra los hijos horizontalmente si no ocupan todo el ancho */
            padding: 0; /* Elimina padding directo del body para aplicarlo en el contenedor de contenido */
        }
        /* Grano/Ruido sutil para el fondo, copiado de la landing page */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAAD9gGz5AAAAAXNSR0IB2cksfwAAAAlwSFlzAAAWJQAAFiUAUFXgxwAAABhQTFRFAAAAsND/sND/sND/sND/sND/sND/sND/sND/jQ0vAAAACnRSTlMAAAAA+wD49z8nBA+MvK+1nQAAABpJREFUeJxjYmBgZGSAjYAAhjFGEGAABgBcA1M77D2NwgAAAABJRU5ErkJggg=='); /* Pequeña imagen de grano */
            background-repeat: repeat;
            opacity: 0.02; /* Muy baja opacidad */
            pointer-events: none; /* Asegura que no interfiera con interacciones */
            z-index: -1;
        }

        /* Define una variable CSS para la fuente del encabezado */
        :root {
            --heading-font: 'Montserrat', sans-serif; /* Montserrat aplicada por defecto ahora */
        }

        /* Aplica la fuente Montserrat a todos los h1 y h2 */
        h1, h2 {
            font-family: var(--heading-font);
        }

        /* Estilo para la tarjeta principal del dashboard, con bordes y sombras neón */
        .dashboard-card {
            background-color: #1a202c; /* Fondo oscuro para la tarjeta */
            border: 1px solid rgba(6, 182, 212, 0.3); /* Borde cian sutil */
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.2), 0 0 80px rgba(168, 85, 247, 0.1); /* Doble sombra neón */
            border-radius: 1.5rem; /* Bordes más redondeados */
            /* section-glow from other modules */
            box-shadow:
                0 0 40px rgba(34, 211, 238, 0.1), /* Sombra principal más fuerte */
                0 0 80px rgba(34, 211, 238, 0.05), /* Sombra de halo exterior */
                0 0 120px rgba(6, 182, 212, 0.03); /* Sombra más difusa */
            transition: box-shadow 0.5s ease-in-out; /* Transición suave para el brillo */
        }
        .dashboard-card:hover {
            box-shadow:
                0 0 60px rgba(34, 211, 238, 0.15),
                0 0 100px rgba(34, 211, 238, 0.08),
                0 0 150px rgba(6, 182, 212, 0.05);
        }

        /* Clases para texto con efecto neón */
        .neon-text-cyan {
            color: #06b6d4; /* Cian neón */
            text-shadow: 0 0 5px #06b6d4, 0 0 10px #06b6d4;
        }
        .neon-text-purple {
            color: #a855f7; /* Púrpura neón */
            text-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7;
        }
        .neon-text-gold {
            color: #fbbf24; /* Dorado neón */
            text-shadow: 0 0 5px #fbbf24, 0 0 10px #fbbf24;
        }

        /* Estilos para el termómetro emocional */
        .emotion-thermometer-bg {
            background-color: #374151; /* Fondo del termómetro */
            border-radius: 0.5rem;
            overflow: hidden; /* Para contener el gradiente */
            height: 16rem; /* fixed height for thermometer */
        }
        .emotion-level {
            width: 100%;
            height: 0%; /* Altura inicial en 0 */
            /* Gradiente que va de rojo (bajo) a verde (alto) */
            background: linear-gradient(to top, #ef4444 0%, #f97316 30%, #eab308 60%, #22c55e 100%);
            transition: height 0.8s ease-out; /* Animación suave para el cambio de altura */
            border-radius: 0.5rem;
        }

        /* Estilos para los íconos de emoción */
        .emotion-icon-active {
            filter: drop-shadow(0 0 8px #fbbf24) drop-shadow(0 0 12px #fbbf24); /* Efecto de brillo para ícono activo */
            transform: scale(1.1); /* Ligeramente más grande */
            transition: all 0.3s ease-in-out;
        }
        .emotion-icon {
            font-size: 2.5rem; /* Tamaño de los íconos de emoción */
            opacity: 0.5; /* Opacidad para los inactivos */
            transition: all 0.3s ease-in-out;
            margin-top: 0.5rem; /* Added margin for spacing */
        }

        /* Estilos para el indicador de riesgo */
        .risk-indicator {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
        }
        .risk-low {
            background-color: rgba(34, 197, 94, 0.2); /* Verde semitransparente */
            color: #22c55e; /* Verde brillante */
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }
        .risk-medium {
            background-color: rgba(234, 179, 8, 0.2); /* Amarillo semitransparente */
            color: #eab308; /* Amarillo brillante */
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.4);
        }
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2); /* Rojo semitransparente */
            color: #ef4444; /* Rojo brillante */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        /* Estilos para el botón de análisis */
        .analyze-button {
            background-color: #a855f7; /* Púrpura */
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5); /* Sombra de neón */
            transition: all 0.3s ease-in-out;
        }
        .analyze-button:hover:not(:disabled) {
            background-color: #9333ea; /* Púrpura más oscuro */
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.8);
            transform: translateY(-2px);
        }
        .analyze-button:disabled {
            background-color: #6b7280; /* Gris para deshabilitado */
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Animación para el ícono de cerebro IA */
        .ai-brain-icon {
            font-size: 3rem;
            filter: drop-shadow(0 0 5px #06b6d4); /* Sombra de neón cian */
            animation: pulse 2s infinite alternate; /* Animación de pulsación */
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        /* Estilos para el loader (spinner) */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #06b6d4; /* Cian */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1a202c;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(6, 182, 212, 0.5);
            color: #e2e8f0;
        }
        .modal-content h3 {
            color: #fbbf24;
            text-shadow: 0 0 5px #fbbf24;
        }
        .modal-content p {
            color: #b0b4b8;
        }
        .modal-close-button {
            background-color: #a855f7;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
        }
        .modal-close-button:hover {
            background-color: #9333ea;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
        }

        /* Estilos para la sección de análisis bloqueada */
        .analyzer-locked {
            background-color: rgba(251, 191, 36, 0.1); /* Amarillo dorado semitransparente */
            border: 2px solid #fbbf24; /* Borde dorado */
            color: #fbbf24; /* Texto dorado */
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        /* Estilo para el logo de la aplicación principal */
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem; /* Espacio antes del título */
        }
        .logo-container img {
            max-width: 100px; /* Tamaño máximo del logo */
            height: auto;
            margin-right: 1rem; /* Espacio entre el logo y el título */
            filter: drop-shadow(0 0 5px rgba(6, 182, 212, 0.5)); /* Efecto sutil neón para el logo */
        }

        /* Estilos para el pie de página */
        .app-footer {
            margin-top: 2.5rem; /* Espacio superior para separar del contenido */
            padding-top: 1.5rem;
            border-top: 1px solid rgba(6, 182, 212, 0.2); /* Línea divisoria cian sutil */
            text-align: center;
            color: #94a3b8; /* Gris azulado para el texto del pie de página */
            font-size: 0.875rem; /* Texto más pequeño */
        }
        .app-footer .academy-logo {
            max-width: 80px; /* Tamaño del logo de la academia */
            height: auto;
            margin: 0 auto 0.75rem auto; /* Centrar y añadir margen inferior */
            opacity: 0.7; /* Ligeramente más tenue para el pie de página */
            filter: drop-shadow(0 0 5px rgba(6, 182, 212, 0.5)); /* Mismo efecto sutil neón para el logo del pie de página */
        }
        .app-footer p {
            margin-bottom: 0.5rem; /* Espacio debajo del párrafo */
        }
        .social-icon {
            font-size: 1.8rem; /* Tamaño del ícono por defecto en footer */
            color: #E5E7EB; /* Color por defecto */
            transition: color 0.3s ease, transform 0.3s ease;
        }
        .social-icon:hover {
            transform: translateY(-3px) scale(1.1); /* Efecto de elevación y escala sutil */
        }
        .social-icon.header-social {
            font-size: 2.8rem; /* Tamaño más grande para íconos en el header */
        }
        .social-icon.fa-telegram:hover {
            color: #0088CC; /* Color de Telegram */
        }
        .social-icon.fa-instagram:hover {
            color: #E4405F; /* Color de Instagram */
        }
        .social-icon.fa-facebook:hover {
            color: #1877F2; /* Color de Facebook */
        }
        .social-icon.fa-tiktok:hover {
            color: #69C9D0; /* Color de TikTok (principal) */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <!-- Contenedor principal para el header y main, para controlar el centrado y padding -->
    <div class="flex-grow w-full max-w-4xl mx-auto p-4 sm:p-8">
        <header class="text-center py-8 bg-gray-800 rounded-2xl dashboard-card mb-10">
            <!-- Logo al principio de la página -->
            <img src="https://i.postimg.cc/nVW2PvKM/logo-png-oficial-fondo-trasparente.png" alt="Logo para_traders_" class="mx-auto h-24 w-auto mb-6 opacity-90">

            <p class="text-lg font-semibold text-emerald-400 uppercase">HERRAMIENTA CLAVE</p>
            <h1 class="text-4xl md:text-5xl font-black mt-2">Analizador de Emociones – Versión Pro</h1>

            <!-- Redes Sociales en Header -->
            <div class="flex justify-center space-x-8 mt-8 mb-4">
                <a href="https://t.me/erostrading" target="_blank" rel="noopener noreferrer" aria-label="Telegram de para_traders_">
                    <i class="fab fa-telegram header-social social-icon text-gray-300 hover:text-cyan-400"></i>
                </a>
                <a href="https://www.instagram.com/para_traders__?igsh=MXd0eGdtZ3ZnaWJxag==" target="_blank" rel="noopener noreferrer" aria-label="Instagram de para_traders_">
                    <i class="fab fa-instagram header-social social-icon text-gray-300 hover:text-pink-500"></i>
                </a>
                <a href="https://www.facebook.com/paraltraders" target="_blank" rel="noopener noreferrer" aria-label="Facebook de para_traders_">
                    <i class="fab fa-facebook header-social social-icon text-gray-300 hover:text-blue-600"></i>
                </a>
                <a href="https://www.tiktok.com/@para_traders?_t=ZT-8yicg47qPio&_r=1" target="_blank" rel="noopener noreferrer" aria-label="TikTok de para_traders_">
                    <i class="fab fa-tiktok header-social social-icon text-gray-300 hover:text-teal-400"></i>
                </a>
            </div>
        </header>

        <main class="space-y-10">
            <div class="dashboard-card p-8 sm:p-10 md:p-12 w-full text-white">
                <!-- Título principal y etiqueta "Impulsado por IA" -->
                <div class="text-center mb-10">
                    <p class="text-xl sm:text-2xl font-light neon-text-cyan mt-2">
                        Impulsado por IA <span class="ai-brain-icon">🧠</span>
                    </p>
                </div>

                <!-- Contenedor principal del dashboard con diseño de cuadrícula -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                    <!-- Columna Izquierda: Gráfico de Emociones (Termómetro Emocional) e Íconos -->
                    <div class="lg:col-span-1 flex flex-col items-center p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                        <h2 class="text-2xl font-bold mb-6 text-gray-200">Estado Emocional Detectado</h2>
                        <div class="emotion-thermometer-bg h-64 w-16 relative mb-6">
                            <div id="emotion-level-bar" class="emotion-level"></div>
                        </div>
                        <div id="emotion-icons" class="flex flex-col space-y-4">
                            <!-- Íconos de emociones con colores específicos -->
                            <span id="emotion-miedo" class="emotion-icon text-red-400" role="img" aria-label="Miedo">😨</span>
                            <span id="emotion-ansiedad" class="emotion-icon text-orange-400" role="img" aria-label="Ansiedad">😟</span>
                            <span id="emotion-codicia" class="emotion-icon text-yellow-400" role="img" aria-label="Codicia">🤑</span>
                            <span id="emotion-euforia" class="emotion-icon text-purple-400" role="img" aria-label="Euforia">🤩</span>
                            <span id="emotion-calma" class="emotion-icon text-green-400" role="img" aria-label="Calma">😌</span>
                        </div>
                    </div>

                    <!-- Columna Central/Derecha: Entrada de Texto, Nivel de Riesgo, Recomendaciones y Resultado del Análisis -->
                    <div class="lg:col-span-2 flex flex-col space-y-8">
                        <!-- Sección de Entrada de Texto y Botón de Análisis -->
                        <div class="p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                            <h2 class="text-2xl font-bold mb-4 text-gray-200">Analiza tu Experiencia</h2>
                            <textarea id="trader-text" class="w-full h-40 bg-gray-900 border-2 border-gray-700 rounded-lg p-4 text-lg text-gray-200 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition" placeholder="Ej: 'Entré tarde por miedo a perder, luego el precio subió sin mí y sentí mucha frustración. En la siguiente operación, arriesgué más para recuperar...'"></textarea>
                            <div class="mt-6 text-center">
                                <button id="analyze-button" onclick="performAIAnalysis()" class="analyze-button text-white font-bold py-3 px-8 rounded-lg text-xl">
                                    Analizar mi Emoción (<span id="trial-count"></span> Uso de Prueba)
                                </button>
                            </div>
                            <div id="loader" class="mt-8 flex justify-center hidden">
                                <div class="loader"></div>
                            </div>
                        </div>

                        <!-- Sección: Nivel de Riesgo Emocional -->
                        <div class="p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                            <h2 class="text-2xl font-bold mb-4 text-gray-200">Nivel de Riesgo Emocional</h2>
                            <div id="risk-level-indicator" class="risk-indicator text-xl">
                                Inicia el análisis...
                            </div>
                        </div>

                        <!-- Sección: Recomendaciones Personalizadas -->
                        <div class="p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                            <h2 class="text-2xl font-bold mb-4 text-gray-200">Recomendaciones Personalizadas</h2>
                            <p id="recommendations-text" class="text-gray-300 leading-relaxed">
                                Aquí verás consejos basados en el análisis de tu texto.
                            </p>
                        </div>

                        <!-- Sección de Resultado Detallado del Análisis de IA -->
                        <div id="analysis-result" class="mt-2 min-h-[5rem] bg-gray-900 border-2 border-gray-700 rounded-lg p-6 text-left text-gray-200 hidden">
                            <h3 class="text-xl font-bold neon-text-cyan mb-2">Análisis Detallado de IA:</h3>
                            <p id="ai-full-analysis" class="text-gray-300 leading-relaxed"></p>
                        </div>

                        <!-- Sección de Análisis Bloqueado -->
                        <div id="analyzer-locked" class="mt-8 p-8 text-center hidden analyzer-locked">
                            <h3 class="text-2xl font-bold text-amber-300">¡Análisis Completado!</h3>
                            <p class="mt-2 text-amber-200">Has usado tus 8 análisis de hoy. Vuelve mañana para más o contacta soporte para la versión ilimitada.</p>
                        </div>
                    </div>
                </div>

                <!-- Nueva Sección: Resumen Emocional General -->
                <div id="overall-emotional-summary" class="mt-8 p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                    <h2 class="text-2xl font-bold mb-4 text-gray-200">Resumen Emocional General</h2>
                    <p id="overall-summary-text" class="text-gray-300 leading-relaxed">
                        Se necesitan al menos 3 análisis para generar un resumen emocional general.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal personalizado -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button onclick="hideModal()" class="modal-close-button">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Pie de página con logo de academia y disclaimer -->
    <footer class="app-footer">
        <img class="academy-logo" src="https://i.postimg.cc/nVW2PvKM/logo-png-oficial-fondo-trasparente.png" alt="Logo de la Academia">
        <div class="flex justify-center space-x-6 mb-4">
            <a href="https://t.me/erostrading" target="_blank" rel="noopener noreferrer" aria-label="Telegram de para_traders_">
                <i class="fab fa-telegram social-icon"></i>
            </a>
            <a href="https://www.instagram.com/para_traders__?igsh=MXd0eGdtZ3ZnaWJxag==" target="_blank" rel="noopener noreferrer" aria-label="Instagram de para_traders_">
                <i class="fab fa-instagram social-icon"></i>
            </a>
            <a href="https://www.facebook.com/paraltraders" target="_blank" rel="noopener noreferrer" aria-label="Facebook de para_traders_">
                <i class="fab fa-facebook social-icon"></i>
            </a>
            <a href="https://www.tiktok.com/@para_traders?_t=ZT-8yicg47qPio&_r=1" target="_blank" rel="noopener noreferrer" aria-label="TikTok de para_traders_">
                <i class="fab fa-tiktok social-icon"></i>
            </a>
        </div>
        <p class="text-gray-500 mt-2 max-w-2xl mx-auto">
            Aviso Legal: El "Analizador de Emociones" es una herramienta educativa y de apoyo psicológico para el trading. La información y las recomendaciones proporcionadas **NO constituyen asesoramiento financiero ni de inversión**. Las decisiones de trading son responsabilidad exclusiva del usuario.
        </p>
    </footer>

    <script>
        // ¡IMPORTANTE! Reemplaza "TU_CLAVE_DE_API_DE_GEMINI_AQUI" con tu clave de API real de Gemini.
        // CUIDADO: Exponer claves de API en el cliente es inseguro para producción.
        const API_KEY = "AIzaSyDebuUKPwhlHqkBMfTxYF6oM_WSYbs6QEI"; // Asegúrate de reemplazar esto con tu clave real.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        const MAX_DAILY_USES = 8; // Actualizado a 8 usos como en el mensaje de bloqueo
        const USES_KEY = 'emotionAnalyzerDailyUses';
        const LAST_USE_DATE_KEY = 'emotionAnalyzerLastUseDate';
        const ANALYSIS_HISTORY_KEY = 'emotionAnalysisHistory'; // Nueva clave para el historial de análisis
        const HISTORY_LIMIT = MAX_DAILY_USES; // Limitar el historial a los últimos X análisis

        let dailyUsesLeft = MAX_DAILY_USES;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toDateString(); // Obtiene la fecha actual sin la hora

            const storedUses = localStorage.getItem(USES_KEY);
            const storedDate = localStorage.getItem(LAST_USE_DATE_KEY);

            if (storedDate === today) {
                // Si la fecha almacenada es la de hoy, carga los usos restantes
                if (storedUses !== null) {
                    dailyUsesLeft = parseInt(storedUses, 10);
                } else {
                    // Si no hay usos almacenados para hoy, se asume el máximo (primer uso del día)
                    dailyUsesLeft = MAX_DAILY_USES;
                }
            } else {
                // Si es un nuevo día, reinicia los usos y actualiza la fecha
                dailyUsesLeft = MAX_DAILY_USES;
                localStorage.setItem(LAST_USE_DATE_KEY, today);
                localStorage.setItem(USES_KEY, dailyUsesLeft);
                localStorage.removeItem(ANALYSIS_HISTORY_KEY); // Limpiar historial para el nuevo día
            }
            updateTrialDisplay();
            updateOverallEmotionalSummary(); // Llamar al cargar para mostrar el resumen inicial
        });

        /**
         * Actualiza el contador de usos diarios en la interfaz y habilita/deshabilita el botón.
         */
        function updateTrialDisplay() {
            const analyzeButton = document.getElementById('analyze-button');
            const analyzerLocked = document.getElementById('analyzer-locked');
            const trialCountSpan = document.getElementById('trial-count'); 

            if (dailyUsesLeft <= 0) {
                analyzeButton.disabled = true;
                analyzeButton.classList.add('hidden'); // Oculta el botón
                analyzerLocked.classList.remove('hidden'); // Muestra el mensaje de bloqueo
                analyzerLocked.querySelector('p').textContent = `Has usado tus ${MAX_DAILY_USES} análisis de hoy. Vuelve mañana para más o contacta soporte para la versión ilimitada.`;
            } else {
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('hidden'); // Muestra el botón
                analyzerLocked.classList.add('hidden'); // Oculta el mensaje de bloqueo
                
                if (trialCountSpan) {
                    trialCountSpan.textContent = dailyUsesLeft;
                    analyzeButton.innerHTML = `Analizar mi Emoción (<span id="trial-count">${dailyUsesLeft}</span> Uso${dailyUsesLeft !== 1 ? 's' : ''} Restantes Hoy)`;
                }
            }
        }

        /**
         * Muestra el modal personalizado con un título y mensaje.
         * @param {string} title - El título del modal.
         * @param {string} message - El mensaje del modal.
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        /**
         * Oculta el modal personalizado.
         */
        function hideModal() {
            document.getElementById('custom-modal').style.display = 'none';
        }

        /**
         * Genera y muestra un resumen emocional general basado en los análisis pasados.
         */
        function updateOverallEmotionalSummary() {
            const overallSummaryDiv = document.getElementById('overall-emotional-summary');
            const overallSummaryText = document.getElementById('overall-summary-text');
            const history = JSON.parse(localStorage.getItem(ANALYSIS_HISTORY_KEY) || '[]');

            if (history.length < 3) { // Se necesitan al menos 3 análisis para un resumen significativo
                overallSummaryDiv.classList.remove('hidden'); // Mostrar sección pero con mensaje informativo
                overallSummaryText.className = "text-gray-300 leading-relaxed";
                overallSummaryText.textContent = `Se necesitan al menos 3 análisis (llevas ${history.length}) para generar un resumen emocional general.`;
                return;
            }

            overallSummaryDiv.classList.remove('hidden'); // Asegurarse de que la sección sea visible

            let emotionCounts = {
                "Miedo": 0, "Ansiedad": 0, "Codicia": 0, "Euforia": 0, "Calma": 0, "Mixto": 0
            };
            let totalCalmLevel = 0;

            history.forEach(analysis => {
                if (emotionCounts[analysis.dominantEmotion] !== undefined) {
                    emotionCounts[analysis.dominantEmotion]++;
                } else {
                    emotionCounts["Mixto"]++; // Fallback para emociones inesperadas
                }
                totalCalmLevel += analysis.calmLevel;
            });

            const avgCalmLevel = totalCalmLevel / history.length;

            let mostFrequentEmotion = "Mixto";
            let maxCount = 0;
            for (const emotion in emotionCounts) {
                if (emotionCounts[emotion] > maxCount) {
                    maxCount = emotionCounts[emotion];
                    mostFrequentEmotion = emotion;
                }
            }

            let summary = "";
            let summaryClass = "text-gray-300"; // Default neutral color

            if (mostFrequentEmotion === "Calma" && avgCalmLevel >= 80) {
                summary = "¡Excelente consistencia emocional! Tu tendencia es a operar con **calma y objetividad**. Sigue fortaleciendo esta fortaleza.";
                summaryClass = "text-green-400";
            } else if (mostFrequentEmotion === "Euforia" && avgCalmLevel >= 60) {
                summary = "Se observa una tendencia a la euforia. Si bien es positivo, ten cuidado con el **exceso de confianza** para evitar riesgos innecesarios. Mantente disciplinado.";
                summaryClass = "text-yellow-400";
            } else if (mostFrequentEmotion === "Codicia" && avgCalmLevel <= 50) {
                summary = "Hay signos de **codicia**. Ten precaución con la sobreexposición o el aumento de lotaje sin justificación. Revisa tu plan de trading y los objetivos realistas.";
                summaryClass = "text-orange-400";
            }
            else if ((mostFrequentEmotion === "Miedo" || mostFrequentEmotion === "Ansiedad") && avgCalmLevel <= 40) {
                summary = "Se observa una tendencia hacia el **miedo o la ansiedad**. Es crucial trabajar en la gestión del riesgo y la mentalidad para evitar parálisis o decisiones impulsivas. Considera una pausa y técnicas de relajación.";
                summaryClass = "text-red-400";
            } else {
                summary = "Tu estado emocional es **mixto o inconsistente**. Es importante identificar patrones y detonantes para lograr una mayor estabilidad emocional en tus operaciones. Continúa registrando tus experiencias.";
                summaryClass = "text-purple-400"; // Color para mixto
            }
            
            overallSummaryText.textContent = summary;
            overallSummaryText.className = `leading-relaxed font-semibold ${summaryClass}`; // Aplicar color dinámico y negrita
        }

        /**
         * Realiza el análisis emocional del texto usando la IA de Gemini.
         * Actualiza la interfaz con el resultado, el nivel de riesgo y las recomendaciones.
         */
        async function performAIAnalysis() {
            // Check if API_KEY is still the placeholder. If so, guide the user.
            if (API_KEY === "TU_CLAVE_DE_API_DE_GEMINI_AQUI") {
                showModal('Error de Configuración', 'Por favor, reemplaza "TU_CLAVE_DE_API_DE_GEMINI_AQUI" con tu clave de API real de Gemini en el código para que la aplicación funcione.');
                return;
            }

            if (dailyUsesLeft <= 0) {
                showModal('Análisis Bloqueado', `Has utilizado tus ${MAX_DAILY_USES} usos de hoy. Vuelve mañana para más.`);
                return;
            }

            const traderText = document.getElementById('trader-text').value.trim();
            if (!traderText) {
                showModal('Entrada Vacía', 'Por favor, describe tu experiencia en el cuadro de texto para analizar tus emociones.');
                return;
            }

            const loader = document.getElementById('loader');
            const analysisResultDiv = document.getElementById('analysis-result');
            const aiFullAnalysisP = document.getElementById('ai-full-analysis');
            const analyzeButton = document.getElementById('analyze-button');

            // Mostrar loader y deshabilitar botón
            loader.classList.remove('hidden');
            analysisResultDiv.classList.add('hidden');
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = 'Analizando...'; 

            // Resetear íconos de emoción
            const emotionIcons = {
                miedo: document.getElementById('emotion-miedo'),
                ansiedad: document.getElementById('emotion-ansiedad'),
                codicia: document.getElementById('emotion-codicia'),
                euforia: document.getElementById('emotion-euforia'),
                calma: document.getElementById('emotion-calma'),
            };
            // Added 'mixto' as an emotion, so initialize it as well.
            // If it's not present in the HTML, it will be null and the null check will prevent errors.
            const mixedEmotionIcon = document.getElementById('emotion-mixto'); 
            if (mixedEmotionIcon) emotionIcons.mixto = mixedEmotionIcon;


            Object.values(emotionIcons).forEach(icon => {
                if (icon) { // Check if icon exists before trying to manipulate it
                    icon.classList.remove('emotion-icon-active');
                    icon.style.opacity = '0.5';
                    icon.style.filter = 'none';
                    icon.style.transform = 'scale(1)';
                }
            });

            // Prompt para la IA
            const prompt = `Analiza el siguiente texto de un trader y proporciona un objeto JSON con las siguientes propiedades:
            - "dominantEmotion": la emoción principal detectada (solo una de: "Miedo", "Ansiedad", "Codicia", "Euforia", "Calma", "Mixto").
            - "calmLevel": un número entero de 0 a 100 que representa el nivel de calma/objetividad emocional (0 = pánico/emociones negativas extremas, 100 = total calma/objetividad).
            - "recommendation": una recomendación concisa y específica para el trading basada en esta emoción y nivel de calma.
            - "fullAnalysis": una breve explicación (2-3 frases) del porqué se detectó esa emoción y el nivel de calma.

            Texto a analizar: "${traderText}"`;

            let retries = 0;
            const MAX_RETRIES = 3;
            const BASE_DELAY = 1000; // 1 segundo

            while (retries < MAX_RETRIES) {
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "dominantEmotion": { "type": "STRING", "enum": ["Miedo", "Ansiedad", "Codicia", "Euforia", "Calma", "Mixto"] },
                                    "calmLevel": { "type": "INTEGER", "minimum": 0, "maximum": 100 },
                                    "recommendation": { "type": "STRING" },
                                    "fullAnalysis": { "type": "STRING" }
                                }
                            }
                        }
                    };

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text(); // Intenta leer el cuerpo del error como texto
                        console.error(`Error HTTP ${response.status}:`, errorBody);
                        
                        // Detectar específicamente el error de API Key no válida
                        if (response.status === 400 && errorBody.includes("API key not valid")) {
                            throw new Error("API_KEY_INVALID");
                        } else {
                            throw new Error(`Error HTTP ${response.status} de la API: ${errorBody.substring(0, 100)}...`); 
                        }
                    }

                    const result = await response.json();

                    if (!result.candidates || result.candidates.length === 0 ||
                        !result.candidates[0].content || !result.candidates[0].content.parts ||
                        result.candidates[0].content.parts.length === 0) {
                        console.error("Estructura de respuesta inesperada del API. Resultado completo:", result);
                        throw new Error("Estructura de respuesta inesperada del API o contenido vacío.");
                    }
                    
                    const jsonString = result.candidates[0].content.parts[0].text;
                    let parsedJson;
                    try {
                        parsedJson = JSON.parse(jsonString);
                    } catch (parseError) {
                        console.error("Error al parsear JSON de la API:", parseError, "String recibido:", jsonString);
                        throw new Error("Respuesta JSON inválida de la API.");
                    }

                    const { dominantEmotion, calmLevel, recommendation, fullAnalysis } = parsedJson;

                    // Actualizar termómetro y íconos de emoción
                    const emotionLevelBar = document.getElementById('emotion-level-bar');
                    emotionLevelBar.style.height = `${calmLevel}%`;

                    const emotionMap = {
                        "Miedo": "miedo", "Ansiedad": "ansiedad", "Codicia": "codicia",
                        "Euforia": "euforia", "Calma": "calma", "Mixto": "mixto" 
                    };
                    const mappedEmotion = emotionMap[dominantEmotion];
                    if (emotionIcons[mappedEmotion]) {
                        emotionIcons[mappedEmotion].classList.add('emotion-icon-active');
                        emotionIcons[mappedEmotion].style.opacity = '1';
                        // Keep text-shadow and transform as defined in CSS for active
                    }

                    // Actualizar Nivel de Riesgo
                    const riskLevelIndicator = document.getElementById('risk-level-indicator');
                    let riskClass = '';
                    let riskText = '';
                    if (calmLevel <= 30) {
                        riskText = 'ALTO';
                        riskClass = 'risk-high';
                    } else if (calmLevel <= 70) {
                        riskText = 'MODERADO';
                        riskClass = 'risk-medium';
                    } else {
                        riskText = 'BAJO';
                        riskClass = 'risk-low';
                    }
                    riskLevelIndicator.textContent = `Nivel: ${riskText}`;
                    riskLevelIndicator.className = `risk-indicator ${riskClass}`;

                    // Actualizar Recomendaciones
                    document.getElementById('recommendations-text').textContent = recommendation;

                    // Mostrar Análisis Detallado
                    aiFullAnalysisP.textContent = fullAnalysis;
                    analysisResultDiv.classList.remove('hidden');

                    // Decrementar usos restantes y guardar
                    dailyUsesLeft--;
                    localStorage.setItem(USES_KEY, dailyUsesLeft);

                    // Guardar análisis en el historial
                    let history = JSON.parse(localStorage.getItem(ANALYSIS_HISTORY_KEY) || '[]');
                    history.push({ dominantEmotion, calmLevel, recommendation, fullAnalysis, text: traderText });
                    if (history.length > HISTORY_LIMIT) {
                        history = history.slice(history.length - HISTORY_LIMIT); // Mantener solo los últimos X
                    }
                    localStorage.setItem(ANALYSIS_HISTORY_KEY, JSON.stringify(history));

                    updateTrialDisplay();
                    updateOverallEmotionalSummary(); // Actualizar el resumen general
                    break; // Salir del bucle si es exitoso

                } catch (error) {
                    loader.classList.add('hidden'); // Ocultar loader
                    analyzeButton.disabled = false; // Habilitar botón
                    analyzeButton.innerHTML = `Analizar mi Emoción (<span id="trial-count">${dailyUsesLeft}</span> Uso${dailyUsesLeft !== 1 ? 's' : ''} Restantes Hoy)`;

                    console.error("Error durante el análisis:", error);
                    let errorMessage = "Ocurrió un error inesperado al analizar tu texto. Intenta de nuevo.";
                    if (error.message === "API_KEY_INVALID") {
                        errorMessage = 'Tu clave de API de Gemini no es válida. Por favor, reemplaza "TU_CLAVE_DE_API_DE_GEMINI_AQUI" en el código.';
                    } else if (error.message.includes("Error HTTP 429")) { // Too Many Requests
                        errorMessage = "Demasiadas solicitudes. Por favor, espera un momento antes de intentarlo de nuevo.";
                    } else if (error.message.includes("Error HTTP") || error.message.includes("Estructura de respuesta inesperada")) {
                        errorMessage = "Problemas con la respuesta del servidor o la clave de API. Verifica la consola para más detalles.";
                    }
                    showModal('Error de Análisis', errorMessage);
                    retries++;
                    if (retries < MAX_RETRIES) {
                        const delay = BASE_DELAY * Math.pow(2, retries -1); // Exponential backoff
                        console.log(`Reintentando en ${delay / 1000} segundos...`);
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        showModal('Error Crítico', 'Fallaron múltiples intentos de conexión. Por favor, revisa tu conexión a internet o la configuración de la API.');
                    }
                }
            }
        }
    </script>
</body>
</html>
