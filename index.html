<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Emociones ‚Äì Versi√≥n Pro</title>
    <!-- Incluye Tailwind CSS desde CDN para estilos minimalistas y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base para la fuente y el fondo oscuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Muy oscuro, casi negro */
            color: #e2e8f0; /* Texto claro */
            overflow-x: hidden; /* Evita barras de desplazamiento horizontales innecesarias */
        }
        /* Estilo para la tarjeta principal del dashboard, con bordes y sombras ne√≥n */
        .dashboard-card {
            background-color: #1a202c; /* Fondo oscuro para la tarjeta */
            border: 1px solid rgba(6, 182, 212, 0.3); /* Borde cian sutil */
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.2), 0 0 80px rgba(168, 85, 247, 0.1); /* Doble sombra ne√≥n */
            border-radius: 1.5rem; /* Bordes m√°s redondeados */
        }
        /* Clases para texto con efecto ne√≥n */
        .neon-text-cyan {
            color: #06b6d4; /* Cian ne√≥n */
            text-shadow: 0 0 5px #06b6d4, 0 0 10px #06b6d4;
        }
        .neon-text-purple {
            color: #a855f7; /* P√∫rpura ne√≥n */
            text-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7;
        }
        .neon-text-gold {
            color: #fbbf24; /* Dorado ne√≥n */
            text-shadow: none; /* Sin text-shadow para m√°xima nitidez */
        }

        /* Estilos para el term√≥metro emocional */
        .emotion-thermometer-bg {
            background-color: #374151; /* Fondo del term√≥metro */
            border-radius: 0.5rem;
            overflow: hidden; /* Para contener el gradiente */
        }
        .emotion-level {
            width: 100%;
            height: 0%; /* Altura inicial en 0 */
            /* Gradiente que va de rojo (bajo) a verde (alto) */
            background: linear-gradient(to top, #ef4444 0%, #f97316 30%, #eab308 60%, #22c55e 100%);
            transition: height 0.8s ease-out; /* Animaci√≥n suave para el cambio de altura */
            border-radius: 0.5rem;
        }

        /* Estilos para los √≠conos de emoci√≥n */
        .emotion-icon-active {
            filter: drop-shadow(0 0 8px #fbbf24) drop-shadow(0 0 12px #fbbf24); /* Efecto de brillo para √≠cono activo */
            transform: scale(1.1); /* Ligeramente m√°s grande */
            transition: all 0.3s ease-in-out;
        }
        .emotion-icon {
            font-size: 2.5rem; /* Tama√±o de los √≠conos de emoci√≥n */
            opacity: 0.5; /* Opacidad para los inactivos */
            transition: all 0.3s ease-in-out;
        }

        /* Estilos para el indicador de riesgo */
        .risk-indicator {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.4s ease-in-out, color 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
        }
        .risk-low {
            background-color: rgba(34, 197, 94, 0.2); /* Verde semitransparente */
            color: #22c55e; /* Verde brillante */
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }
        .risk-medium {
            background-color: rgba(234, 179, 8, 0.2); /* Amarillo semitransparente */
            color: #eab308; /* Amarillo brillante */
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.4);
        }
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2); /* Rojo semitransparente */
            color: #ef4444; /* Rojo brillante */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        /* Estilos para el bot√≥n de an√°lisis */
        .analyze-button {
            background-color: #a855f7; /* P√∫rpura */
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5); /* Sombra de ne√≥n */
            transition: all 0.3s ease-in-out;
        }
        .analyze-button:hover:not(:disabled) {
            background-color: #9333ea; /* P√∫rpura m√°s oscuro */
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.8);
            transform: translateY(-2px);
        }
        .analyze-button:disabled {
            background-color: #6b7280; /* Gris para deshabilitado */
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Animaci√≥n para el √≠cono de cerebro IA */
        .ai-brain-icon {
            font-size: 3rem;
            filter: drop-shadow(0 0 5px #06b6d4); /* Sombra de ne√≥n cian */
            animation: pulse 2s infinite alternate; /* Animaci√≥n de pulsaci√≥n */
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        /* Estilos para el loader (spinner) */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #06b6d4; /* Cian */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1a202c;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(6, 182, 212, 0.5);
            color: #e2e8f0;
        }
        .modal-content h3 {
            color: #fbbf24;
            text-shadow: 0 0 5px #fbbf24;
        }
        .modal-content p {
            color: #b0b4b8;
        }
        .modal-close-button {
            background-color: #a855f7;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
        }
        .modal-close-button:hover {
            background-color: #9333ea;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
        }

        /* Estilos para la secci√≥n de an√°lisis bloqueada */
        .analyzer-locked {
            background-color: rgba(251, 191, 36, 0.1); /* Amarillo dorado semitransparente */
            border: 2px solid #fbbf24; /* Borde dorado */
            color: #fbbf24; /* Texto dorado */
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        /* Estilo para el logo de la aplicaci√≥n principal */
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem; /* Espacio antes del t√≠tulo */
        }
        .logo-container img {
            max-width: 100px; /* Tama√±o m√°ximo del logo */
            height: auto;
            margin-right: 1rem; /* Espacio entre el logo y el t√≠tulo */
            filter: drop-shadow(0 0 5px rgba(6, 182, 212, 0.5)); /* Efecto sutil ne√≥n para el logo */
        }

        /* Estilos para el pie de p√°gina */
        .app-footer {
            margin-top: 2.5rem; /* Espacio superior para separar del contenido */
            padding-top: 1.5rem;
            border-top: 1px solid rgba(6, 182, 212, 0.2); /* L√≠nea divisoria cian sutil */
            text-align: center;
            color: #94a3b8; /* Gris azulado para el texto del pie de p√°gina */
            font-size: 0.875rem; /* Texto m√°s peque√±o */
        }
        .app-footer .academy-logo {
            max-width: 80px; /* Tama√±o del logo de la academia */
            height: auto;
            margin: 0 auto 0.75rem auto; /* Centrar y a√±adir margen inferior */
            opacity: 0.7; /* Ligeramente m√°s tenue para el pie de p√°gina */
            filter: drop-shadow(0 0 5px rgba(6, 182, 212, 0.5)); /* Mismo efecto sutil ne√≥n para el logo del pie de p√°gina */
        }
        .app-footer p {
            margin-bottom: 0.5rem; /* Espacio debajo del p√°rrafo */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="dashboard-card p-8 sm:p-10 md:p-12 w-full max-w-4xl text-white">
        <!-- T√≠tulo principal y etiqueta "Impulsado por IA" -->
        <div class="text-center mb-10">
            <!-- Contenedor para el logo y el t√≠tulo -->
            <div class="logo-container">
                <img id="app-logo" src="https://i.postimg.cc/nVW2PvKM/logo-png-oficial-fondo-trasparente.png" alt="Logo de la Aplicaci√≥n">
                <h1 class="text-4xl sm:text-5xl font-extrabold neon-text-gold">
                    Analizador de Emociones ‚Äì Versi√≥n Pro
                </h1>
            </div>
            <p class="text-xl sm:text-2xl font-light neon-text-cyan mt-2">
                Impulsado por IA <span class="ai-brain-icon">üß†</span>
            </p>
        </div>

        <!-- Contenedor principal del dashboard con dise√±o de cuadr√≠cula -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <!-- Columna Izquierda: Gr√°fico de Emociones (Term√≥metro Emocional) e √çconos -->
            <div class="lg:col-span-1 flex flex-col items-center p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                <h2 class="text-2xl font-bold mb-6 text-gray-200">Estado Emocional Detectado</h2>
                <div class="emotion-thermometer-bg h-64 w-16 relative mb-6">
                    <div id="emotion-level-bar" class="emotion-level"></div>
                </div>
                <div id="emotion-icons" class="flex flex-col space-y-4">
                    <!-- √çconos de emociones con colores espec√≠ficos -->
                    <span id="emotion-miedo" class="emotion-icon text-red-400" role="img" aria-label="Miedo">üò®</span>
                    <span id="emotion-ansiedad" class="emotion-icon text-orange-400" role="img" aria-label="Ansiedad">üòü</span>
                    <span id="emotion-codicia" class="emotion-icon text-yellow-400" role="img" aria-label="Codicia">ü§ë</span>
                    <span id="emotion-euforia" class="emotion-icon text-purple-400" role="img" aria-label="Euforia">ü§©</span>
                    <span id="emotion-calma" class="emotion-icon text-green-400" role="img" aria-label="Calma">üòå</span>
                </div>
            </div>

            <!-- Columna Central/Derecha: Entrada de Texto, Nivel de Riesgo, Recomendaciones y Resultado del An√°lisis -->
            <div class="lg:col-span-2 flex flex-col space-y-8">
                <!-- Secci√≥n de Entrada de Texto y Bot√≥n de An√°lisis -->
                <div class="p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                    <h2 class="text-2xl font-bold mb-4 text-gray-200">Analiza tu Experiencia</h2>
                    <textarea id="trader-text" class="w-full h-40 bg-gray-900 border-2 border-gray-700 rounded-lg p-4 text-lg text-gray-200 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition" placeholder="Ej: 'Entr√© tarde por miedo a perder, luego el precio subi√≥ sin m√≠ y sent√≠ mucha frustraci√≥n. En la siguiente operaci√≥n, arriesgu√© m√°s para recuperar...'"></textarea>
                    <div class="mt-6 text-center">
                        <button id="analyze-button" onclick="performAIAnalysis()" class="analyze-button text-white font-bold py-3 px-8 rounded-lg text-xl">
                            Analizar mi Emoci√≥n (<span id="trial-count"></span> Uso de Prueba)
                        </button>
                    </div>
                    <div id="loader" class="mt-8 flex justify-center hidden">
                        <div class="loader"></div>
                    </div>
                </div>

                <!-- Secci√≥n: Nivel de Riesgo Emocional -->
                <div class="p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                    <h2 class="text-2xl font-bold mb-4 text-gray-200">Nivel de Riesgo Emocional</h2>
                    <div id="risk-level-indicator" class="risk-indicator text-xl">
                        Inicia el an√°lisis...
                    </div>
                </div>

                <!-- Secci√≥n: Recomendaciones Personalizadas -->
                <div class="p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
                    <h2 class="text-2xl font-bold mb-4 text-gray-200">Recomendaciones Personalizadas</h2>
                    <p id="recommendations-text" class="text-gray-300 leading-relaxed">
                        Aqu√≠ ver√°s consejos basados en el an√°lisis de tu texto.
                    </p>
                </div>

                <!-- Secci√≥n de Resultado Detallado del An√°lisis de IA -->
                <div id="analysis-result" class="mt-2 min-h-[5rem] bg-gray-900 border-2 border-gray-700 rounded-lg p-6 text-left text-gray-200 hidden">
                    <h3 class="text-xl font-bold neon-text-cyan mb-2">An√°lisis Detallado de IA:</h3>
                    <p id="ai-full-analysis" class="text-gray-300 leading-relaxed"></p>
                </div>

                <!-- Secci√≥n de An√°lisis Bloqueado -->
                <div id="analyzer-locked" class="mt-8 p-8 text-center hidden analyzer-locked">
                    <h3 class="text-2xl font-bold text-amber-300">¬°An√°lisis Completado!</h3>
                    <p class="mt-2 text-amber-200">Has usado tus 8 an√°lisis de hoy. Vuelve ma√±ana para m√°s o contacta soporte para la versi√≥n ilimitada.</p>
                </div>
            </div>
        </div>

        <!-- Nueva Secci√≥n: Resumen Emocional General -->
        <div id="overall-emotional-summary" class="mt-8 p-6 bg-gray-800 rounded-lg shadow-inner-lg border border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Resumen Emocional General</h2>
            <p id="overall-summary-text" class="text-gray-300 leading-relaxed">
                Se necesitan al menos 3 an√°lisis para generar un resumen emocional general.
            </p>
        </div>

        <!-- Pie de p√°gina con logo de academia y disclaimer -->
        <footer class="app-footer">
            <img class="academy-logo" src="https://i.postimg.cc/nVW2PvKM/logo-png-oficial-fondo-trasparente.png" alt="Logo de la Academia">
            <p class="text-gray-500 mt-2">
                Aviso Legal: El "Analizador de Emociones" es una herramienta educativa y de apoyo psicol√≥gico para el trading. La informaci√≥n y las recomendaciones proporcionadas **NO constituyen asesoramiento financiero ni de inversi√≥n**. Las decisiones de trading son responsabilidad exclusiva del usuario.
            </p>
        </footer>
    </div>

    <!-- Modal personalizado -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button onclick="hideModal()" class="modal-close-button">
                Cerrar
            </button>
        </div>
    </div>

    <script>
        // ¬°IMPORTANTE! Reemplaza "TU_CLAVE_DE_API_DE_GEMINI_AQUI" con tu clave de API real de Gemini.
        // CUIDADO: Exponer claves de API en el cliente es inseguro para producci√≥n.
        const API_KEY = "AIzaSyDebuUKPwhlHqkBMfTxYF6oM_WSYbs6QEI"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        const MAX_DAILY_USES = 6;
        const USES_KEY = 'emotionAnalyzerDailyUses';
        const LAST_USE_DATE_KEY = 'emotionAnalyzerLastUseDate';
        const ANALYSIS_HISTORY_KEY = 'emotionAnalysisHistory'; // Nueva clave para el historial de an√°lisis
        const HISTORY_LIMIT = MAX_DAILY_USES; // Limitar el historial a los √∫ltimos X an√°lisis

        let dailyUsesLeft = MAX_DAILY_USES;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toDateString(); // Obtiene la fecha actual sin la hora

            const storedUses = localStorage.getItem(USES_KEY);
            const storedDate = localStorage.getItem(LAST_USE_DATE_KEY);

            if (storedDate === today) {
                // Si la fecha almacenada es la de hoy, carga los usos restantes
                if (storedUses !== null) {
                    dailyUsesLeft = parseInt(storedUses, 10);
                } else {
                    // Si no hay usos almacenados para hoy, se asume el m√°ximo (primer uso del d√≠a)
                    dailyUsesLeft = MAX_DAILY_USES;
                }
            } else {
                // Si es un nuevo d√≠a, reinicia los usos y actualiza la fecha
                dailyUsesLeft = MAX_DAILY_USES;
                localStorage.setItem(LAST_USE_DATE_KEY, today);
                localStorage.setItem(USES_KEY, dailyUsesLeft);
                localStorage.removeItem(ANALYSIS_HISTORY_KEY); // Limpiar historial para el nuevo d√≠a
            }
            updateTrialDisplay();
            updateOverallEmotionalSummary(); // Llamar al cargar para mostrar el resumen inicial
        });

        /**
         * Actualiza el contador de usos diarios en la interfaz y habilita/deshabilita el bot√≥n.
         */
        function updateTrialDisplay() {
            const analyzeButton = document.getElementById('analyze-button');
            const analyzerLocked = document.getElementById('analyzer-locked');
            const trialCountSpan = document.getElementById('trial-count'); 

            if (dailyUsesLeft <= 0) {
                analyzeButton.disabled = true;
                analyzeButton.classList.add('hidden'); // Oculta el bot√≥n
                analyzerLocked.classList.remove('hidden'); // Muestra el mensaje de bloqueo
                analyzerLocked.querySelector('p').textContent = `Has usado tus ${MAX_DAILY_USES} an√°lisis de hoy. Vuelve ma√±ana para m√°s o contacta soporte para la versi√≥n ilimitada.`;
            } else {
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('hidden'); // Muestra el bot√≥n
                analyzerLocked.classList.add('hidden'); // Oculta el mensaje de bloqueo
                
                if (trialCountSpan) {
                    trialCountSpan.textContent = dailyUsesLeft;
                    analyzeButton.innerHTML = `Analizar mi Emoci√≥n (<span id="trial-count">${dailyUsesLeft}</span> Uso${dailyUsesLeft !== 1 ? 's' : ''} Restantes Hoy)`;
                }
            }
        }

        /**
         * Muestra el modal personalizado con un t√≠tulo y mensaje.
         * @param {string} title - El t√≠tulo del modal.
         * @param {string} message - El mensaje del modal.
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        /**
         * Oculta el modal personalizado.
         */
        function hideModal() {
            document.getElementById('custom-modal').style.display = 'none';
        }

        /**
         * Genera y muestra un resumen emocional general basado en los an√°lisis pasados.
         */
        function updateOverallEmotionalSummary() {
            const overallSummaryDiv = document.getElementById('overall-emotional-summary');
            const overallSummaryText = document.getElementById('overall-summary-text');
            const history = JSON.parse(localStorage.getItem(ANALYSIS_HISTORY_KEY) || '[]');

            if (history.length < 3) { // Se necesitan al menos 3 an√°lisis para un resumen significativo
                overallSummaryDiv.classList.remove('hidden'); // Mostrar secci√≥n pero con mensaje informativo
                overallSummaryText.className = "text-gray-300 leading-relaxed";
                overallSummaryText.textContent = `Se necesitan al menos 3 an√°lisis (llevas ${history.length}) para generar un resumen emocional general.`;
                return;
            }

            overallSummaryDiv.classList.remove('hidden'); // Asegurarse de que la secci√≥n sea visible

            let emotionCounts = {
                "Miedo": 0, "Ansiedad": 0, "Codicia": 0, "Euforia": 0, "Calma": 0, "Mixto": 0
            };
            let totalCalmLevel = 0;

            history.forEach(analysis => {
                if (emotionCounts[analysis.dominantEmotion] !== undefined) {
                    emotionCounts[analysis.dominantEmotion]++;
                } else {
                    emotionCounts["Mixto"]++; // Fallback para emociones inesperadas
                }
                totalCalmLevel += analysis.calmLevel;
            });

            const avgCalmLevel = totalCalmLevel / history.length;

            let mostFrequentEmotion = "Mixto";
            let maxCount = 0;
            for (const emotion in emotionCounts) {
                if (emotionCounts[emotion] > maxCount) {
                    maxCount = emotionCounts[emotion];
                    mostFrequentEmotion = emotion;
                }
            }

            let summary = "";
            let summaryClass = "text-gray-300"; // Default neutral color

            if (mostFrequentEmotion === "Calma" && avgCalmLevel >= 80) {
                summary = "¬°Excelente consistencia emocional! Tu tendencia es a operar con **calma y objetividad**. Sigue fortaleciendo esta fortaleza.";
                summaryClass = "text-green-400";
            } else if (mostFrequentEmotion === "Euforia" && avgCalmLevel >= 60) {
                summary = "Se observa una tendencia a la euforia. Si bien es positivo, ten cuidado con el **exceso de confianza** para evitar riesgos innecesarios. Mantente disciplinado.";
                summaryClass = "text-yellow-400";
            } else if (mostFrequentEmotion === "Codicia" && avgCalmLevel <= 50) {
                summary = "Hay signos de **codicia**. Ten precauci√≥n con la sobreexposici√≥n o el aumento de lotaje sin justificaci√≥n. Revisa tu plan de trading y los objetivos realistas.";
                summaryClass = "text-orange-400";
            }
            else if ((mostFrequentEmotion === "Miedo" || mostFrequentEmotion === "Ansiedad") && avgCalmLevel <= 40) {
                summary = "Se observa una tendencia hacia el **miedo o la ansiedad**. Es crucial trabajar en la gesti√≥n del riesgo y la mentalidad para evitar par√°lisis o decisiones impulsivas. Considera una pausa y t√©cnicas de relajaci√≥n.";
                summaryClass = "text-red-400";
            } else {
                summary = "Tu estado emocional es **mixto o inconsistente**. Es importante identificar patrones y detonantes para lograr una mayor estabilidad emocional en tus operaciones. Contin√∫a registrando tus experiencias.";
                summaryClass = "text-purple-400"; // Color para mixto
            }
            
            overallSummaryText.textContent = summary;
            overallSummaryText.className = `leading-relaxed font-semibold ${summaryClass}`; // Aplicar color din√°mico y negrita
        }

        /**
         * Realiza el an√°lisis emocional del texto usando la IA de Gemini.
         * Actualiza la interfaz con el resultado, el nivel de riesgo y las recomendaciones.
         */
        async function performAIAnalysis() {
            // Check if API_KEY is still the placeholder. If so, guide the user.
            if (API_KEY === "TU_CLAVE_DE_API_DE_GEMINI_AQUI") {
                showModal('Error de Configuraci√≥n', 'Por favor, reemplaza "TU_CLAVE_DE_API_DE_GEMINI_AQUI" con tu clave de API real de Gemini en el c√≥digo para que la aplicaci√≥n funcione.');
                return;
            }

            if (dailyUsesLeft <= 0) {
                showModal('An√°lisis Bloqueado', `Has utilizado tus ${MAX_DAILY_USES} usos de hoy. Vuelve ma√±ana para m√°s.`);
                return;
            }

            const traderText = document.getElementById('trader-text').value.trim();
            if (!traderText) {
                showModal('Entrada Vac√≠a', 'Por favor, describe tu experiencia en el cuadro de texto para analizar tus emociones.');
                return;
            }

            const loader = document.getElementById('loader');
            const analysisResultDiv = document.getElementById('analysis-result');
            const aiFullAnalysisP = document.getElementById('ai-full-analysis');
            const analyzeButton = document.getElementById('analyze-button');

            // Mostrar loader y deshabilitar bot√≥n
            loader.classList.remove('hidden');
            analysisResultDiv.classList.add('hidden');
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = 'Analizando...'; 

            // Resetear √≠conos de emoci√≥n
            const emotionIcons = {
                miedo: document.getElementById('emotion-miedo'),
                ansiedad: document.getElementById('emotion-ansiedad'),
                codicia: document.getElementById('emotion-codicia'),
                euforia: document.getElementById('emotion-euforia'),
                calma: document.getElementById('emotion-calma'),
            };
            Object.values(emotionIcons).forEach(icon => {
                icon.classList.remove('emotion-icon-active');
                icon.style.opacity = '0.5';
                icon.style.filter = 'none';
                icon.style.transform = 'scale(1)';
            });

            // Prompt para la IA
            const prompt = `Analiza el siguiente texto de un trader y proporciona un objeto JSON con las siguientes propiedades:
            - "dominantEmotion": la emoci√≥n principal detectada (solo una de: "Miedo", "Ansiedad", "Codicia", "Euforia", "Calma", "Mixto").
            - "calmLevel": un n√∫mero entero de 0 a 100 que representa el nivel de calma/objetividad emocional (0 = p√°nico/emociones negativas extremas, 100 = total calma/objetividad).
            - "recommendation": una recomendaci√≥n concisa y espec√≠fica para el trading basada en esta emoci√≥n y nivel de calma.
            - "fullAnalysis": una breve explicaci√≥n (2-3 frases) del porqu√© se detect√≥ esa emoci√≥n y el nivel de calma.

            Texto a analizar: "${traderText}"`;

            let retries = 0;
            const MAX_RETRIES = 3;
            const BASE_DELAY = 1000; // 1 segundo

            while (retries < MAX_RETRIES) {
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "dominantEmotion": { "type": "STRING", "enum": ["Miedo", "Ansiedad", "Codicia", "Euforia", "Calma", "Mixto"] },
                                    "calmLevel": { "type": "INTEGER", "minimum": 0, "maximum": 100 },
                                    "recommendation": { "type": "STRING" },
                                    "fullAnalysis": { "type": "STRING" }
                                }
                            }
                        }
                    };

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text(); // Intenta leer el cuerpo del error como texto
                        console.error(`Error HTTP ${response.status}:`, errorBody);
                        
                        // Detectar espec√≠ficamente el error de API Key no v√°lida
                        if (response.status === 400 && errorBody.includes("API key not valid")) {
                             throw new Error("API_KEY_INVALID");
                        } else {
                             throw new Error(`Error HTTP ${response.status} de la API: ${errorBody.substring(0, 100)}...`); 
                        }
                    }

                    const result = await response.json();

                    if (!result.candidates || result.candidates.length === 0 ||
                        !result.candidates[0].content || !result.candidates[0].content.parts ||
                        result.candidates[0].content.parts.length === 0) {
                        console.error("Estructura de respuesta inesperada del API. Resultado completo:", result);
                        throw new Error("Estructura de respuesta inesperada del API o contenido vac√≠o.");
                    }
                    
                    const jsonString = result.candidates[0].content.parts[0].text;
                    let parsedJson;
                    try {
                        parsedJson = JSON.parse(jsonString);
                    } catch (parseError) {
                        console.error("Error al parsear JSON de la API:", parseError, "String recibido:", jsonString);
                        throw new Error("Respuesta JSON inv√°lida de la API.");
                    }

                    const { dominantEmotion, calmLevel, recommendation, fullAnalysis } = parsedJson;

                    // Actualizar term√≥metro y √≠conos de emoci√≥n
                    const emotionLevelBar = document.getElementById('emotion-level-bar');
                    emotionLevelBar.style.height = `${calmLevel}%`;

                    const emotionMap = {
                        "Miedo": "miedo", "Ansiedad": "ansiedad", "Codicia": "codicia",
                        "Euforia": "euforia", "Calma": "calma", "Mixto": "mixto" 
                    };
                    const mappedEmotion = emotionMap[dominantEmotion];
                    if (emotionIcons[mappedEmotion]) {
                        emotionIcons[mappedEmotion].classList.add('emotion-icon-active');
                        emotionIcons[mappedEmotion].style.opacity = '1';
                    }

                    // Actualizar Nivel de Riesgo
                    const riskLevelIndicator = document.getElementById('risk-level-indicator');
                    let riskClass = '';
                    let riskText = '';
                    if (calmLevel <= 30) {
                        riskText = 'ALTO';
                        riskClass = 'risk-high';
                    } else if (calmLevel <= 70) {
                        riskText = 'MODERADO';
                        riskClass = 'risk-medium';
                    } else {
                        riskText = 'BAJO';
                        riskClass = 'risk-low';
                    }
                    riskLevelIndicator.textContent = `Nivel: ${riskText}`;
                    riskLevelIndicator.className = `risk-indicator ${riskClass}`;

                    // Actualizar Recomendaciones
                    document.getElementById('recommendations-text').textContent = recommendation;

                    // Mostrar An√°lisis Detallado
                    aiFullAnalysisP.textContent = fullAnalysis;
                    analysisResultDiv.classList.remove('hidden');

                    let history = JSON.parse(localStorage.getItem(ANALYSIS_HISTORY_KEY) || '[]');
                    history.push({
                        timestamp: new Date().toISOString(),
                        dominantEmotion,
                        calmLevel
                    });
                    if (history.length > HISTORY_LIMIT) {
                        history = history.slice(history.length - HISTORY_LIMIT);
                    }
                    localStorage.setItem(ANALYSIS_HISTORY_KEY, JSON.stringify(history));

                    dailyUsesLeft--;
                    localStorage.setItem(USES_KEY, dailyUsesLeft);
                    localStorage.setItem(LAST_USE_DATE_KEY, new Date().toDateString()); 
                    updateTrialDisplay(); 
                    updateOverallEmotionalSummary(); 

                    break; 

                } catch (error) {
                    console.error("Error al llamar a la API de Gemini:", error);
                    // Manejo espec√≠fico para API_KEY_INVALID
                    if (error.message === "API_KEY_INVALID") {
                         showModal('Error de Clave de API', 'Tu clave de API de Gemini no es v√°lida. Por favor, aseg√∫rate de haberla reemplazado correctamente en el c√≥digo JavaScript.');
                         loader.classList.add('hidden');
                         analyzeButton.disabled = false;
                         updateTrialDisplay();
                         return; // Sale de la funci√≥n sin reintentar si la clave es inv√°lida
                    }

                    retries++;
                    if (retries < MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, BASE_DELAY * Math.pow(2, retries - 1)));
                    } else {
                        showModal('Error en el An√°lisis', `No se pudo completar el an√°lisis de emociones. Mensaje: ${error.message || 'Error desconocido'}. Int√©ntalo de nuevo m√°s tarde.`);
                        analyzeButton.disabled = false;
                        updateTrialDisplay();
                        loader.classList.add('hidden');
                        analysisResultDiv.classList.add('hidden');
                    }
                }
            }
            loader.classList.add('hidden');
            updateTrialDisplay(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (dailyUsesLeft > 0) {
                const emotionalScore = Math.floor(Math.random() * 101);
                document.getElementById('emotion-level-bar').style.height = `${emotionalScore}%`;
                updateInitialEmotionalState(emotionalScore);
            } else {
                document.getElementById('emotion-level-bar').style.height = '0%'; 
                document.getElementById('risk-level-indicator').textContent = 'An√°lisis bloqueado';
                document.getElementById('risk-level-indicator').className = 'risk-indicator result-neutral';
                document.getElementById('recommendations-text').textContent = `Has usado tus ${MAX_DAILY_USES} an√°lisis de hoy. Vuelve ma√±ana para m√°s.`;
                document.getElementById('analysis-result').classList.add('hidden');
            }
        });

        function updateInitialEmotionalState(emotionalScore) {
            const riskLevelIndicator = document.getElementById('risk-level-indicator');
            const recommendationsText = document.getElementById('recommendations-text');
            const emotionIcons = {
                miedo: document.getElementById('emotion-miedo'),
                ansiedad: document.getElementById('emotion-ansiedad'),
                codicia: document.getElementById('emotion-codicia'),
                euforia: document.getElementById('emotion-euforia'),
                calma: document.getElementById('emotion-calma'),
            };

            let dominantEmotion = '';
            if (emotionalScore < 20) {
                dominantEmotion = 'miedo';
            } else if (emotionalScore < 40) {
                dominantEmotion = 'ansiedad';
            } else if (emotionalScore < 60) {
                dominantEmotion = 'codicia';
            } else if (emotionalScore < 80) {
                dominantEmotion = 'euforia';
            } else {
                dominantEmotion = 'calma';
            }

            Object.values(emotionIcons).forEach(icon => {
                icon.classList.remove('emotion-icon-active');
                icon.style.opacity = '0.5';
                icon.style.filter = 'none';
                icon.style.transform = 'scale(1)';
            });

            if (emotionIcons[dominantEmotion]) {
                emotionIcons[dominantEmotion].classList.add('emotion-icon-active');
                emotionIcons[dominantEmotion].style.opacity = '1';
            }

            let riskLevel = '';
            let recommendation = '';
            let riskClass = '';

            if (emotionalScore <= 30) {
                riskLevel = 'ALTO';
                recommendation = 'Nivel emocional cr√≠tico. El miedo o la ansiedad pueden llevar a decisiones impulsivas. Considera una pausa y un ejercicio de respiraci√≥n profunda.';
                riskClass = 'risk-high';
            } else if (emotionalScore <= 70) {
                riskLevel = 'MODERADO';
                recommendation = 'Tu estado es manejable, pero la codicia o euforia pueden distorsionar tu juicio. Mant√©n la objetividad y sigue tu plan de trading estrictamente.';
                riskClass = 'risk-medium';
            } else {
                riskLevel = 'BAJO';
                recommendation = 'Excelente estado emocional. Est√°s en √≥ptimas condiciones para ejecutar tu plan de trading con disciplina y claridad. ¬°Adelante con precauci√≥n!';
                riskClass = 'risk-low';
            }

            riskLevelIndicator.textContent = `Nivel: ${riskLevel}`;
            riskLevelIndicator.className = `risk-indicator ${riskClass}`;
            recommendationsText.textContent = recommendation;
        }
    </script>
</body>
</html>
